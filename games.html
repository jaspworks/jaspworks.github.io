<!DOCTYPE html>
<html lang="en">
<head>
    <base href="https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/">
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    <script async src="https://fundingchoicesmessages.google.com/i/pub-5521219086088837?ers=1"></script>
    <script>(function() {function signalGooglefcPresent() {if (!window.frames['googlefcPresent']) {if (document.body) {const iframe = document.createElement('iframe'); iframe.style = 'width: 0; height: 0; border: none; z-index: -1000; left: -1000px; top: -1000px;'; iframe.style.display = 'none'; iframe.name = 'googlefcPresent'; document.body.appendChild(iframe);} else {setTimeout(signalGooglefcPresent, 0);}}}signalGooglefcPresent();})();</script>
    <script src="https://cdn.jsdelivr.net/gh/gn-math/gn-math-DONTDMCA@main/gnmath.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sn</title>
    <style>
        :root {
    --primary: #ffffff;
    --primary-hover: #000000;
    --primary-light: rgba(0, 0, 0, 0.15);
    --primary-glow: rgba(255, 255, 255, 0.5);
    --accent: #ffffff;
    --text: #dddddd;
    --text-muted: #b0b0b0;
    --text-light: #888888;
    --bg: #000000;
    --bg-secondary: #0d0d0d;
    --surface: #1a1a1a;
    --surface-hover: #252525;
    --border: #2a2a2a;
    --border-light: #333333;
    --shadow: 0 4px 12px rgba(0, 0, 0, 0.8);
    --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.9);
    --shadow-glow: 0 0 30px var(--primary-glow);
    --radius: 0px;
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Doto', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    line-height: 1.6;
    background: var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    position: relative;
}

#particles {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
    pointer-events: none;
}

header, main, #zoneViewer, #popupOverlay {
    position: relative;
    z-index: 10;
}
header {
    background: transparent;
    border-bottom: none;
    position: sticky;
    top: 0;
    z-index: 100;
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 2rem 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
}

.search-container {
    font-family: 'Doto';
    display: flex;
    flex: 1;
    max-width: 800px;
    gap: 0.75rem;
}

#searchBar {
    font-family: 'Doto';
    flex: 1;
    padding: 0.875rem 1.25rem;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text);
    font-size: 15px;
    font-weight: 500;
    outline: none;
    transition: all 0.3s ease;
}

#searchBar:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
    background: var(--surface-hover);
}

#searchBar::placeholder {
    color: var(--text-muted);
}

#sortOptions,
#filterOptions {
    padding: 0.875rem 1.25rem;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--surface);
    color: var(--text);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    outline: none;
    transition: all 0.3s ease;
    min-width: 140px;
}

#sortOptions:hover,
#filterOptions:hover {
    border-color: var(--primary);
    background: var(--surface-hover);
}


main {
    font-family: 'Doto';
    margin: 0 auto;
    padding: 1rem 2rem 3rem;
    max-width: 1400px;
}


#container {
    font-family: 'Doto';
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1.5rem;
}

.zone-item {
    font-family: 'Doto';
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    position: relative;
}

.zone-item::before {
    font-family: 'Doto';
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--primary-light) 0%, transparent 100%);
    opacity: 0;
    transition: opacity 0.4s ease;
    pointer-events: none;
    z-index: 1;
}

.zone-item:hover {
    font-family: 'Doto';
    transform: translateY(-12px) scale(1.03);
    border-color: var(--primary);
    box-shadow: var(--shadow-glow), var(--shadow-lg);
}

.zone-item:hover::before {
    font-family: 'Doto';
    opacity: 1;
}

.zone-item img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
    display: block;
    background: var(--bg-secondary);
    transition: transform 0.4s ease;
}

.zone-item:hover img {
    transform: scale(1.08);
}

.zone-item button {
    font-family: 'Doto';
    background: transparent;
    color: var(--text);
    border: 0;
    padding: 1.25rem 1rem;
    cursor: pointer;
    font-weight: 700;
    font-size: 14px;
    line-height: 1.3;
    text-align: center;
    transition: all 0.3s ease;
    min-height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 2;
}

.zone-item:hover button {
    color: var(--primary);
}


#zoneViewer {
    position: fixed;
    inset: 0;
    background: var(--bg);
    z-index: 1000;
    display: none;
    flex-direction: column;
    animation: slideInUp 0.3s ease;
}

@keyframes slideInUp {
    from { transform: translateY(100%); }
    to { transform: translateY(0); }
}


.zone-header {
    position: absolute;
    top: 20px;
    right: 20px;
    background: var(--bg-secondary);
    border: 2px solid var(--primary);
    color: var(--text);
    padding: 0.5rem 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: var(--shadow-glow), var(--shadow-lg);
    border-radius: 12px;
    z-index: 1001;
    max-width: 90%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    user-select: none;
}

.zone-header.dragging {
    transition: none;
}

.zone-header.collapsed {
    top: 0;
    right: 20px;
    padding: 0.25rem 0.5rem;
    border-radius: 0 0 12px 12px;
    border-top: none;
    max-width: 80px;
}

.zone-header.collapsed .zone-title,
.zone-header.collapsed .zone-controls {
    display: none;
}

.drag-handle {
    cursor: move;
    flex-shrink: 0;
}

.drag-handle.dragging {
    cursor: grabbing;
}

.zone-title {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
}

#zoneName {
    font-family: 'Doto';
    font-size: 1rem;
    font-weight: 800;
    margin: 0;
    color: var(--primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#zoneId {
    display: none;
}

#zoneAuthor {
    font-size: 11px;
    color: var(--text-muted);
    text-decoration: none;
    transition: color 0.2s ease;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
}

#zoneAuthor:hover {
    color: var(--primary);
}

.zone-controls {
    display: flex;
    gap: 0.5rem;
    flex-shrink: 0;
}

.zone-controls button {
    background: var(--surface);
    border: 2px solid var(--border);
    color: var(--text);
    padding: 0.375rem 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 700;
    transition: all 0.3s ease;
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
    min-width: 32px;
    height: 32px;
}

.zone-controls button svg {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
}

.zone-controls button:hover {
    background: var(--primary);
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-glow);
}

#toggleHeaderBtn {
    background: var(--surface);
    border: 2px solid var(--border);
    color: var(--text);
    padding: 0.375rem 0.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 32px;
    height: 32px;
    flex-shrink: 0;
}

.zone-header.collapsed #toggleHeaderBtn {
    padding: 0.25rem 0.375rem;
    font-size: 12px;
    min-width: 28px;
    height: 28px;
    border-radius: 6px;
}

#toggleHeaderBtn:hover {
    background: var(--primary);
    border-color: var(--primary);
    transform: scale(1.05);
}

#zoneFrame {
    flex-grow: 1;
    border: none;
    width: 100%;
    height: 100%;
}

/* Roblox Button */
.roblox-button {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 14px;
    font-weight: 700;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
}

.roblox-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.6);
}

/* Popup */
#popupOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(12px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 1rem;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.popup {
    background: var(--surface);
    border: 2px solid var(--primary);
    border-radius: var(--radius);
    box-shadow: var(--shadow-glow), var(--shadow-lg);
    width: 100%;
    max-width: 600px;
    max-height: 85vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: slideInScale 0.3s ease;
}

@keyframes slideInScale {
    from {
        transform: scale(0.9) translateY(20px);
        opacity: 0;
    }
    to {
        transform: scale(1) translateY(0);
        opacity: 1;
    }
}

.popup-header {
    background: var(--bg-secondary);
    border-bottom: 2px solid var(--primary);
    color: var(--text);
    padding: 1.5rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#popupTitle {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--primary);
}

#popupClose {
    background: var(--surface);
    border: 2px solid var(--border);
    color: var(--text);
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: var(--radius);
    transition: all 0.3s ease;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
}

#popupClose:hover {
    background: var(--primary);
    border-color: var(--primary);
    transform: rotate(90deg);
}

#popupBody {
    padding: 2rem;
    overflow-y: auto;
    color: var(--text);
}

#popupBody input[type="text"],
#popupBody input[type="file"] {
    width: 100%;
    padding: 1rem 1.25rem;
    margin-bottom: 1.5rem;
    border: 2px solid var(--border);
    border-radius: var(--radius);
    background: var(--bg-secondary);
    color: var(--text);
    font-size: 15px;
    font-weight: 500;
    transition: all 0.3s ease;
    outline: none;
}

#popupBody input[type="text"]:focus,
#popupBody input[type="file"]:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px var(--primary-light);
}

.settings-button {
    background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    font-size: 16px;
    font-weight: 700;
    border-radius: var(--radius);
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    text-align: center;
    box-shadow: 0 4px 12px var(--primary-glow);
}

.settings-button:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-glow);
}


@media (max-width: 768px) {
    .header-content {
        padding: 1.5rem 1rem 1rem;
    }

    .search-container {
        width: 100%;
        max-width: none;
        flex-wrap: wrap;
    }

    main {
        padding: 1rem;
    }

    #container {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 1rem;
    }

    .zone-header {
        top: 10px;
        right: 10px;
        padding: 0.5rem 0.625rem;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .zone-header.collapsed {
        top: 0;
        right: 10px;
        padding: 0.25rem 0.375rem;
        max-width: 70px;
    }

    #zoneName {
        font-family: 'Doto';
        font-size: 0.875rem;
    }

    .zone-controls {
        width: 100%;
        gap: 0.375rem;
    }

    .zone-controls button {
        flex: 1;
        padding: 0.375rem;
        font-size: 10px;
        min-width: 28px;
        height: 28px;
    }
    
    .zone-controls button svg {
        width: 12px;
        height: 12px;
    }
}

@media (max-width: 480px) {
    #container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
}
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff6b00">
</head>
<body>
    <canvas id="particles"></canvas>
    
    <header>
        <div class="header-content">
            <div class="search-container">
                <input type="text" id="searchBar" placeholder="Search zones..." oninput="filterZones()">
                <select id="sortOptions" onchange="sortZones()">
                    <option style="font-family: 'Doto';" value="name">Name</option>
                    <option style="font-family: 'Doto';" value="id">id</option>
                    <option style="font-family: 'Doto';" value="popular">popular</option>
                </select>
                <select id="filterOptions" onchange="filterZones2()">
                    <option style="font-family: 'Doto';" value="none">Tag</option>
                </select>
            </div>
        </div>
    </header>
    
    <main>
        <div id="container">Loading...</div>
    </main>

    <div id="zoneViewer">
        <div class="zone-header" id="zoneHeader">
            <div class="drag-handle" id="dragHandle">
                <button id="toggleHeaderBtn" onclick="toggleHeader()" title="Toggle header">▼</button>
            </div>
            <div class="zone-title">
                <h2 id="zoneName">zone</h2>
                <span id="zoneId" style="display: none;"></span>
                <a id="zoneAuthor" href="#" target="_blank">by Author</a>
            </div>
            <div class="zone-controls">
                <button onclick="fullscreenZone()" title="Fullscreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                    </svg>
                </button>
                <button onclick="aboutBlank()" title="New Tab">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
                        <polyline points="15 3 21 3 21 9"/>
                        <line x1="10" y1="14" x2="21" y2="3"/>
                    </svg>
                </button>
                <button onclick="closeZone()" title="Close">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
        </div>
        <iframe id="zoneFrame"></iframe>
    </div>

    <div id="popupOverlay">
        <div class="popup">
            <div class="popup-header">
                <h3 id="popupTitle">Title</h3>
                <button id="popupClose" onclick="closePopup()">×</button>
            </div>
            <div id="popupBody">
                Content will be here
            </div>
        </div>
    </div>

    <ins class="adsbygoogle"
        style="display:block; text-align:center;"
        data-ad-client="ca-pub-5521219086088837"
        data-ad-slot="5549138288"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    
    <script>
const container = document.getElementById('container');
const zoneViewer = document.getElementById('zoneViewer');
let zoneFrame = document.getElementById('zoneFrame');
const searchBar = document.getElementById('searchBar');
const sortOptions = document.getElementById('sortOptions');
const filterOptions = document.getElementById('filterOptions');

const zonesurls = [
    "https://cdn.jsdelivr.net/%67%68/%67%6e%2d%6d%61%74%68/%61%73%73%65%74%73@%6d%61%69%6e/%7a%6f%6e%65%73%2e%6a%73%6f%6e",
    "https://cdn.jsdelivr.net/gh/gn-math/assets@latest/zones.json",
    "https://cdn.jsdelivr.net/gh/gn-math/assets@master/zones.json",
    "https://cdn.jsdelivr.net/gh/gn-math/assets/zones.json"
];
let zonesURL = zonesurls[Math.floor(Math.random() * zonesurls.length)];
const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";
let zones = [];
let popularityData = {};

function toTitleCase(str) {
    return str.replace(
        /\w\S*/g,
        text => text.charAt(0).toUpperCase() + text.substring(1).toLowerCase()
    );
}


function toggleHeader() {
    const header = document.getElementById('zoneHeader');
    const toggleBtn = document.getElementById('toggleHeaderBtn');
    header.classList.toggle('collapsed');
    toggleBtn.textContent = header.classList.contains('collapsed') ? '▲' : '▼';
}


let isDragging = false;
let currentX;
let currentY;
let initialX;
let initialY;
let xOffset = 0;
let yOffset = 0;

function dragStart(e) {
    const header = document.getElementById('zoneHeader');
    const dragHandle = document.getElementById('dragHandle');
    
    if (e.type === "touchstart") {
        initialX = e.touches[0].clientX - xOffset;
        initialY = e.touches[0].clientY - yOffset;
    } else {
        initialX = e.clientX - xOffset;
        initialY = e.clientY - yOffset;
    }

    if (e.target === dragHandle || dragHandle.contains(e.target)) {
        isDragging = true;
        header.classList.add('dragging');
        dragHandle.classList.add('dragging');
    }
}

function dragEnd(e) {
    const header = document.getElementById('zoneHeader');
    const dragHandle = document.getElementById('dragHandle');
    initialX = currentX;
    initialY = currentY;
    isDragging = false;
    header.classList.remove('dragging');
    dragHandle.classList.remove('dragging');
}

function drag(e) {
    if (isDragging) {
        e.preventDefault();
        const header = document.getElementById('zoneHeader');
        
        if (e.type === "touchmove") {
            currentX = e.touches[0].clientX - initialX;
            currentY = e.touches[0].clientY - initialY;
        } else {
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;
        }

        xOffset = currentX;
        yOffset = currentY;

        setTranslate(currentX, currentY, header);
    }
}

function setTranslate(xPos, yPos, el) {
    el.style.transform = `translate(${xPos}px, ${yPos}px)`;
}


document.addEventListener('DOMContentLoaded', () => {
    const dragHandle = document.getElementById('dragHandle');
    
    dragHandle.addEventListener('mousedown', dragStart);
    dragHandle.addEventListener('touchstart', dragStart);
    
    document.addEventListener('mouseup', dragEnd);
    document.addEventListener('touchend', dragEnd);
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('touchmove', drag);
});

async function listZones() {
    try {
        let sharesponse;
        let shajson;
        let sha;
        try {
            sharesponse = await fetch("https://api.github.com/repos/gn-math/assets/commits?t="+Date.now());
        } catch (error) {}
        if (sharesponse && sharesponse.status === 200) {
            try {
                shajson = await sharesponse.json();
                sha = shajson[0]['sha'];
                if (sha) {
                    zonesURL = `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json`;
                }
            } catch (error) {
                try {
                    let secondarysharesponse = await fetch("https://raw.githubusercontent.com/gn-math/xml/refs/heads/main/sha.txt?t="+Date.now());
                    if (secondarysharesponse && secondarysharesponse.status === 200) {
                        sha = (await secondarysharesponse.text()).trim();
                        if (sha) {
                            zonesURL = `https://cdn.jsdelivr.net/gh/gn-math/assets@${sha}/zones.json`;
                        }
                    }
                } catch(error) {}
            }
        }
        const response = await fetch(zonesURL+"?t="+Date.now());
        const json = await response.json();
        
 
        const patcher = [-1,596]; 
        zones = json.filter(zone => !patcher.includes(zone.id));
        
        await fetchPopularity();
        sortZones();
        const search = new URLSearchParams(window.location.search);
        const id = search.get('id');
        const embed = window.location.hash.includes("embed");
        if (id) {
            const zone = zones.find(zone => zone.id + '' == id + '');
            if (zone) {
                if (embed) {
                    if (zone.url.startsWith("http")) {
                        window.open(zone.url, "_blank");
                    } else {
                        const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
                        fetch(url+"?t="+Date.now()).then(response => response.text()).then(html => {
                            document.documentElement.innerHTML = html;
                            const popup = document.createElement("div");
                            popup.style.position = "fixed";
                            popup.style.bottom = "20px";
                            popup.style.right = "20px";
                            popup.style.backgroundColor = "#1a1a1a";
                            popup.style.color = "#ff6b00";
                            popup.style.padding = "10px";
                            popup.style.border = "2px solid #ff6b00";
                            popup.style.borderRadius = "16px";
                            popup.style.boxShadow = "0px 0px 20px rgba(255, 107, 0, 0.5)";
                            popup.style.fontFamily = "'Quicksand', sans-serif";
                            
                            popup.innerHTML = `Play more games at <a href="https://gn-math.github.io" target="_blank" style="color:#ffaa00; font-weight:bold;">https://gn-math.github.io</a>!`;
                            
                            const closeBtn = document.createElement("button");
                            closeBtn.innerText = "✕";
                            closeBtn.style.marginLeft = "10px";
                            closeBtn.style.background = "none";
                            closeBtn.style.border = "none";
                            closeBtn.style.cursor = "pointer";
                            closeBtn.style.color = "#ff6b00";
                            closeBtn.style.fontWeight = "bold";
                            
                            closeBtn.onclick = () => popup.remove();
                            popup.appendChild(closeBtn);
                            document.body.appendChild(popup);
                            document.documentElement.querySelectorAll('script').forEach(oldScript => {
                                const newScript = document.createElement('script');
                                if (oldScript.src) {
                                    newScript.src = oldScript.src;
                                } else {
                                    newScript.textContent = oldScript.textContent;
                                }
                                document.body.appendChild(newScript);
                            });
                        }).catch(error => alert("Failed to load zone: " + error));
                    }
                } else {
                    openZone(zone);
                }
            }
        }

        let alltags = [];
        for (const obj of json) {
            if (Array.isArray(obj.special)) {
                alltags.push(...obj.special);
            }
        }

        alltags = [...new Set(alltags)];
        let filteroption = document.getElementById("filterOptions");
        if (filteroption && filteroption.children.length > 1) {
            while (filteroption.children.length > 1) {
                filteroption.removeChild(filteroption.lastElementChild);
            }
        }
        for (const tag of alltags) {
            const opt = document.createElement("option");
            opt.value = tag;
            opt.textContent = toTitleCase(tag);
            filteroption.appendChild(opt);
        }
    } catch (error) {
        console.error(error);
        container.innerHTML = `Error loading zones: ${error}`;
    }
}

async function fetchPopularity() {
    try {
        const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
        const data = await response.json();
        data.forEach(file => {
            const idMatch = file.name.match(/\/(\d+)\.html$/);
            if (idMatch) {
                const id = parseInt(idMatch[1]);
                popularityData[id] = file.hits.total;
            }
        });
    } catch (error) {
        popularityData[0] = 0;
    }
}

function sortZones() {
    const sortBy = sortOptions.value;
    if (sortBy === 'name') {
        zones.sort((a, b) => a.name.localeCompare(b.name));
    } else if (sortBy === 'id') {
        zones.sort((a, b) => a.id - b.id);
    } else if (sortBy === 'popular') {
        zones.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
    }
    zones.sort((a, b) => (a.id === -1 ? -1 : b.id === -1 ? 1 : 0));
    displayZones(zones);
}

function displayZones(zones) {
    container.innerHTML = "";
    zones.forEach((file, index) => {
        const zoneItem = document.createElement("div");
        zoneItem.className = "zone-item";
        zoneItem.onclick = () => openZone(file);
        const img = document.createElement("img");
        img.dataset.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        img.alt = file.name;
        img.loading = "lazy";
        img.className = "lazy-zone-img";
        zoneItem.appendChild(img);
        const button = document.createElement("button");
        button.textContent = file.name;
        button.onclick = (event) => {
            event.stopPropagation();
            openZone(file);
        };
        zoneItem.appendChild(button);
        container.appendChild(zoneItem);   
    });
    if (container.innerHTML === "") {
        container.innerHTML = "No zones found.";
    }

    const lazyImages = document.querySelectorAll('img.lazy-zone-img');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !zoneViewer.hidden) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove("lazy-zone-img");
                observer.unobserve(img);
            }
        });
    }, {
        rootMargin: "100px", 
        threshold: 0.1
    });

    lazyImages.forEach(img => {
        imageObserver.observe(img);
    });
}

function filterZones2() {
    const query = filterOptions.value;
    if (query === "none") {
        displayZones(zones);
    } else {
        const filteredZones = zones.filter(zone => zone.special?.includes(query));
        displayZones(filteredZones);
    }
}

function filterZones() {
    const query = searchBar.value.toLowerCase();
    const filteredZones = zones.filter(zone => zone.name.toLowerCase().includes(query));
    displayZones(filteredZones);
}

function openZone(file) {
    if (file.url.startsWith("http")) {
        window.open(file.url, "_blank");
    } else {
        const url = file.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        fetch(url+"?t="+Date.now()).then(response => response.text()).then(html => {
            if (zoneFrame.contentDocument === null) {
                zoneFrame = document.createElement("iframe");
                zoneFrame.id = "zoneFrame";
                zoneViewer.appendChild(zoneFrame);
            }
            zoneFrame.contentDocument.open();
            zoneFrame.contentDocument.write(html);
            zoneFrame.contentDocument.close();
            document.getElementById('zoneName').textContent = file.name;
            document.getElementById('zoneId').textContent = file.id;
            document.getElementById('zoneAuthor').textContent = "by " + file.author;
            if (file.authorLink) {
                document.getElementById('zoneAuthor').href = file.authorLink;
            }
            
            // Reset header to expanded state when opening new zone
            const header = document.getElementById('zoneHeader');
            const toggleBtn = document.getElementById('toggleHeaderBtn');
            header.classList.remove('collapsed');
            toggleBtn.textContent = '▼';
            
            // Reset position
            xOffset = 0;
            yOffset = 0;
            header.style.transform = 'translate(0, 0)';
            
            zoneViewer.style.display = "flex";
            const url = new URL(window.location);
            url.searchParams.set('id', file.id);
            history.pushState(null, '', url.toString());
            zoneViewer.hidden = true;
        }).catch(error => alert("Failed to load zone: " + error));
    }
}

function openRoblox() {
    const currentZoneId = document.getElementById('zoneId').textContent;
    const robloxUrl = `embed-wrapper.html?id=${currentZoneId}`;
    window.open(robloxUrl, "_blank");
}

function aboutBlank() {
    const newWindow = window.open("about:blank", "_blank");
    let zone = zones.find(zone => zone.id + '' === document.getElementById('zoneId').textContent).url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
    fetch(zone+"?t="+Date.now()).then(response => response.text()).then(html => {
        if (newWindow) {
            newWindow.document.open();
            newWindow.document.write(html);
            newWindow.document.close();
        }
    })
}

function closeZone() {
    zoneViewer.hidden = false;
    zoneViewer.style.display = "none";
    zoneViewer.removeChild(zoneFrame);
    const url = new URL(window.location);
    url.searchParams.delete('id');
    history.pushState(null, '', url.toString());
}

function downloadZone() {
    let zone = zones.find(zone => zone.id + '' === document.getElementById('zoneId').textContent);
    fetch(zone.url.replace("{HTML_URL}", htmlURL)+"?t="+Date.now()).then(res => res.text()).then(text => {
        const blob = new Blob([text], {
            type: "text/plain;charset=utf-8"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = zone.name + ".html";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
}

function fullscreenZone() {
    if (zoneFrame.requestFullscreen) {
        zoneFrame.requestFullscreen();
    } else if (zoneFrame.mozRequestFullScreen) {
        zoneFrame.mozRequestFullScreen();
    } else if (zoneFrame.webkitRequestFullscreen) {
        zoneFrame.webkitRequestFullscreen();
    } else if (zoneFrame.msRequestFullscreen) {
        zoneFrame.msRequestFullscreen();
    }
}

function darkMode() {
    document.body.classList.toggle("dark-mode");
}

function cloakIcon(url) {
    const link = document.querySelector("link[rel~='icon']");
    link.rel = "icon";
    if ((url+"").trim().length === 0) {
        link.href = "favicon.png";
    } else {
        link.href = url;
    }
    document.head.appendChild(link);
}

function cloakName(string) {
    if ((string+"").trim().length === 0) {
        document.title = "gn-math";
        return;
    }
    document.title = string;
}

function tabCloak() {
    closePopup();
    document.getElementById('popupTitle').textContent = "Tab Cloak";
    const popupBody = document.getElementById('popupBody');
    popupBody.innerHTML = `
        <label for="tab-cloak-textbox" style="font-weight: bold;">Set Tab Title:</label><br>
        <input type="text" id="tab-cloak-textbox" placeholder="Enter new tab name..." oninput="cloakName(this.value)">
        <br><br><br><br>
        <label for="tab-cloak-textbox" style="font-weight: bold;">Set Tab Icon:</label><br>
        <input type="text" id="tab-cloak-textbox" placeholder="Enter new tab icon..." oninput='cloakIcon(this.value)'>
        <br><br><br>
    `;
    popupBody.contentEditable = false;
    document.getElementById('popupOverlay').style.display = "flex";
}

function closePopup() {
    document.getElementById('popupOverlay').style.display = "none";
}

listZones();

// Particles Animation
const canvas = document.getElementById("particles");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
resizeCanvas();

let snowflakes = [];

class deprecated {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = Math.random() * canvas.width;
        this.y = Math.random() * -canvas.height;
        this.size = Math.random() * 3 + 1;
        this.speedY = Math.random() * 2 + 0.5;
        this.speedX = Math.random() * 1 - 0.5;
        this.opacity = Math.random() * 0.7 + 0.3;
    }
    update() {
        this.x += this.speedX + Math.sin(this.y * 0.01) * 0.3;
        this.y += this.speedY;
        if (this.y > canvas.height) {
            this.reset();
            this.y = -10;
        }
    }
    draw() {
        ctx.fillStyle = `rgba(255,255,255,${this.opacity})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

function initSnow() {
    snowflakes = [];
    for (let i = 0; i < 150; i++) {
        snowflakes.push(new Snowflake());
    }
}

function animateSnow() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    snowflakes.forEach(flake => {
        flake.update();
        flake.draw();
    });
    requestAnimationFrame(animateSnow);
}

window.addEventListener("resize", () => {
    resizeCanvas();
    initSnow();
});

initSnow();
animateSnow();

const schoolList = ["deledao", "goguardian", "lightspeed", "linewize", "securly", ".edu/"];

function isBlockedDomain(url) {
    const domain = new URL(url, location.origin).hostname + "/";
    return schoolList.some(school => domain.includes(school));
}

const originalFetch = window.fetch;
window.fetch = function (url, options) {
    if (isBlockedDomain(url)) {
        console.warn(`lam`);
        return Promise.reject(new Error("lam"));
    }
    return originalFetch.apply(this, arguments);
};

const originalOpen = XMLHttpRequest.prototype.open;
XMLHttpRequest.prototype.open = function (method, url) {
    if (isBlockedDomain(url)) {
        console.warn(`lam`);
        return;
    }
    return originalOpen.apply(this, arguments);
};

HTMLCanvasElement.prototype.toDataURL = function (...args) {
    return "";
};
    </script>
    
    <script>
        const search = new URLSearchParams(window.location.search);
        const privacy = search.get('privacy');
        if (privacy) {
            loadPrivacy();
        }
    </script>
    
    <script>
        navigator.serviceWorker.register(location.protocol+"//"+location.hostname+"/sw.js");
    </script>
</body>
</html>